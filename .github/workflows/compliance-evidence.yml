name: compliance-evidence

on:
  pull_request:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  evidence:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Install conftest
        run: |
          set -eux
          curl -L -o conftest.tar.gz https://github.com/open-policy-agent/conftest/releases/download/v0.56.0/conftest_0.56.0_Linux_x86_64.tar.gz
          tar -xzf conftest.tar.gz
          sudo mv conftest /usr/local/bin/conftest

      - name: Policy checks
        run: |
          set -eux
          mkdir -p evidence
          conftest test -p policy/opa --all-namespaces ./gitops ./charts | tee evidence/conftest.txt

      - name: Evidence summary
        run: |
          set -eux
          cat > evidence/evidence-summary.md << EOF
          # SOC2 Evidence Summary

          Repo: ${GITHUB_REPOSITORY}
          Ref: ${GITHUB_REF}
          SHA: ${GITHUB_SHA}
          Run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}

          ## Included evidence
          - Conftest policy checks over gitops/ and charts/
          EOF

          echo "" >> evidence/evidence-summary.md
          echo "## Conftest output (tail)" >> evidence/evidence-summary.md
          echo "\`\`\`" >> evidence/evidence-summary.md
          tail -n 200 evidence/conftest.txt >> evidence/evidence-summary.md || true
          echo "\`\`\`" >> evidence/evidence-summary.md

      - name: Upload evidence artifact
        uses: actions/upload-artifact@v4
        with:
          name: soc2-evidence
          path: evidence/